<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1;text/html; charset=utf-8;" />

		<script>
			var SBpath = "../../../js/";
		</script>
		<script src="../../../js/SBGrid/SBGrid_Lib.js" type="text/javascript"></script>
		<script src="../../../js/SBGrid/SBGrid_min.js" type="text/javascript"></script>
		<link href="../../../js/SBGrid/css/SBGrid.css" rel="stylesheet" type="text/css">
		<link href="../../../js/SBGrid/css/SBGrid_Default.css" rel="stylesheet" type="text/css">
		<link href="../../../css/basic.css" rel="stylesheet" type="text/css">
		<link href="../../../css/common.css" rel="stylesheet" type="text/css">
		<script src="../../../data/data.js" type="text/javascript"></script>
		<script src="../../../js/toggle/toggle.js" type="text/javascript"></script>
<!--		<script src="../../../js/common.js" type="text/javascript"></script>-->
		
		<style>
            .gAjaxParam>tbody>tr>th{
                background-color:rgb(198,217,241);
                padding:5px 20px 5px 20px;
            }
            .gAjaxParam>tbody>tr>td{
                background-color:white;
                padding:5px 20px 5px 20px;
            }
        </style>
		
		<title>jquery ajax 방식</title>
	</head>

	<body>
		<div class="subTitle">
			<h2 class="title">jquery의 ajax()를 이용한 paging 방식</h2>
		</div>
		
		<p class="ctext4">Description</p>
		<ul class="descList">
			<li> ● <span style="font-weight:bold;">DB Paging 을 사용하기 위해서는 paging 속성을 필수로 사용하셔야합니다.(Default Paging 설정 참조)</span></li>
			<li> ● 기존 사용하고계신 ajax 통신 방법을 통해 구현하는 방식입니다.</li>
			<li> ● 페이지가 변경되지 전 이벤트(<span style="font-weight:bold;color: red;">beforepagechanged</span>)를 통해 그리드 데이터를 조회합니다.
		</ul>			
        <div class="example_box">
			<pre>
    
    <span style="font-weight:bold;">이벤트 바인드</span>
    <span style="font-weight:bold;">datagrid.bind(</span> <span style="font-weight:bold;color: red;">"beforepagechanged"</span> , <span style="font-weight:bold;color: red;">"fnPaging()"</span><span style="font-weight:bold;"> );</span>
			</pre>
			<br>
        </div>
		<p class="ctext4">Example</p>
		<ul>
        	<div class="example_box">
<pre>
    <span class="comment"></span>
    <span style="color:blue;font-weight:bold;">function</span> <span style="color:green;font-weight:bold;">fnPaging()</span> {
        <span style="color:blue;font-weight:bold;">var</span> nLimitCount = datagrid.getPageSize();  <span style="color:green;font-weight:bold;">// 몇개의 데이터를 가져올지 설정</span>
        <span style="color:blue;font-weight:bold;">var</span> nIndexStart = (datagrid.getSelectPageIndex() - 1) * nLimitCount; <span style="color:green;font-weight:bold;">// 몇번째 인덱스 부터 데이터를 가져올지 설정</span>

    	//controller에 설정된 페이지 정보를 전달 합니다.
        <span style="color:blue;font-weight:bold;">var</span> objData = { <span style="color:red;font-weight:bold;">"firstIndexSB"</span> : nIndexStart, <span style="color:red;font-weight:bold;">"limitCountSB"</span> : nLimitCount }; 

        $.ajax( {
            url : "<c:url value='/sbGridDBPagingList.do' />",
            type : "POST",
            data : objData,
            dataType : 'json',
           <span style="color:red;font-weight:bold;"> async : false, </span> <span style="color:green;font-weight:bold;"> // async 는 반드시 false로 사용해 주셔야 합니다.</span>
            success : function(result) {
                var resultData = JSON.parse(<span style="color:red;font-weight:bold;">result.reponseData</span>);<span style="color:green;font-weight:bold;"> // server측에서 넘어온 페이징된 조회결과목록</span>
                datagrid.<span style="color:red;font-weight:bold;">setPageTotalCount(result.totalCnt</span>);<span style="color:green;font-weight:bold;"> // 데이터의 총 건수를 'setPageTotalCount' 메소드에 setting</span>
                gridData = resultData;
                datagrid.rebuild();
            },
            error : function(req, stat, error) {
                console.log(error);
            }
        } );
    }

</pre><br>
					<ul>
						<!-- <li> &nbsp;&nbsp;※ gridajax 가 아닌 $.ajax(); 통신을 사용하기 위해서는 <span style="color:red;font-weight:bold;">async 를 반드시 false</span> 로 설정해야합니다.</li> -->
						<!-- <li> &nbsp;&nbsp;※ $.ajax(); 통신을 사용하기 위해서는 <span style="color:red;font-weight:bold;">async 를 반드시 false</span> 로 설정해야합니다.</li>
						<li> &nbsp;&nbsp;※ false 로 설정하지 않을 경우 beforepagechanged 시점 문제가 발생하므로, 반드시 <span style="color:red;font-weight:bold;">false</span>로 설정해 주셔야 합니다.</li> -->
						<li> &nbsp;&nbsp;※ <span style="color:red;font-weight:bold;">beforepagechanged</span> 이벤트 사용시 시점 문제가 발생하기 때문에 반드시 <span style="color:red;font-weight:bold;">$.ajax() async의 속성을 반드시 false</span>로 설정해 주셔야 합니다.</li>
					</ul>
                </div>
			</ul>
		<p class="ctext4">jQuery의 $.ajax() 시 controller</p>
        <div class="example_box">
<pre>

    //페이징 조회결과
    public ModelAndView selectDBPagingList2(HttpServletRequest request, HttpServletResponse response, ModelAndView mav) throws Exception {

        Map&lt;String, String&gt; paramMap = new HashMap&lt;String, String&gt;();

        //paging 사용 시 firstIndexSB 와 limitCountSB를 토대로 시작이 되는 인덱스와, 시작인덱스부터 가져오려는 Data의 갯수를 offset과 limit에 설정해야 합니다.
        <span style="color:red;font-weight:bold;">paramMap.put("offset", request.getParameter("firstIndexSB"));       //'firstIndexSB' 파라메터명은 필수로 DB페이징 적용 시 시작이 되는 Data 인덱스</span>
        <span style="color:red;font-weight:bold;">paramMap.put("limit", request.getParameter("limitCountSB"));        //'limitCountSB' 파라메터명은 필수로 DB페이징 적용 시 시작 인덱스부터 가져오려는 Data의 갯수</span>

        try {
            Gson gson = new Gson();
            
            int resultCnt = sbGridDBPagingService.selectDBTotalCnt(paramMap);<span style="color:green;font-weight:bold;"> // 데이터 총 건수</span>
            List&lt;Map&lt;String, String&gt;&gt; resultList = sbGridDBPagingService.selectDBPagingList(paramMap);<span style="color:green;font-weight:bold;"> // 조회결과목록</span>
            
            mav.addObject("totalCnt", resultCnt);
            mav.addObject("responseData", gson.toJson(resultList));
            
            mav.setViewName("jsonView");
        } catch (IOException e) {
            e.printStackTrace();
        }

        return mav;
    }

</pre><br /><br>
	</body>
</html>