<html>

<head>
    <title>deck.gl HexagonLayer Example</title>

    <script src="https://unpkg.com/deck.gl@^6.0.0/deckgl.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js"></script>

    <style type="text/css">
        body {
            font-family: Helvetica, Arial, sans-serif;
            width: 100vw;
            height: 100vh;
            margin: 0;
        }

        #control-panel {
            position: absolute;
            background: #fff;
            top: 0;
            left: 0;
            margin: 12px;
            padding: 20px;
            font-size: 12px;
            line-height: 1.5;
            z-index: 1;
        }

        label {
            display: inline-block;
            width: 140px;
        }
    </style>
</head>

<body>
    <div id="control-panel">
        <div>
            <label>Radius</label>
            <input id="radius" type="range" min="1000" max="20000" step="1000" value="1000"></input>
            <span id="radius-value"></span>
        </div>
        <div>
            <label>Coverage</label>
            <input id="coverage" type="range" min="0" max="1" step="0.1" value="1"></input>
            <span id="coverage-value"></span>
        </div>
        <div>
            <label>Upper Percentile</label>
            <input id="upperPercentile" type="range" min="90" max="100" step="1" value="100"></input>
            <span id="upperPercentile-value"></span>
        </div>
    </div>
</body>

<script type="text/javascript">

    // Set your mapbox token here
    const MAPBOX_TOKEN = ''; // eslint-disable-line

    // Source data CSV
    const DATA_URL = {
        BUILDINGS:
            'https://raw.githubusercontent.com/uber-common/deck.gl-data/master/examples/trips/buildings.json', // eslint-disable-line
        TRIPS:
            'https://raw.githubusercontent.com/uber-common/deck.gl-data/master/examples/trips/trips.json' // eslint-disable-line
    };

    const LIGHT_SETTINGS = {
        lightsPosition: [-74.05, 40.7, 8000, -73.5, 41, 5000],
        ambientRatio: 0.05,
        diffuseRatio: 0.6,
        specularRatio: 0.8,
        lightsStrength: [2.0, 0.0, 0.0, 0.0],
        numberOfLights: 2
    };

    const INITIAL_VIEW_STATE = {
        longitude: -74,
        latitude: 40.72,
        zoom: 13,
        maxZoom: 16,
        pitch: 45,
        bearing: 0
    };

    class App {
        constructor(props) {
            this.state = {
                time: 0
            };
        }

        componentDidMount() {
            this._animate();
        }

        componentWillUnmount() {
            if (this._animationFrame) {
                window.cancelAnimationFrame(this._animationFrame);
            }
        }

        _animate() {
            const {
                loopLength = 1800, // unit corresponds to the timestamp in source data
                animationSpeed = 30 // unit time per second
            } = this.props;
            const timestamp = Date.now() / 1000;
            const loopTime = loopLength / animationSpeed;

            this.setState({
                time: ((timestamp % loopTime) / loopTime) * loopLength
            });
            this._animationFrame = window.requestAnimationFrame(this._animate.bind(this));
        }

        _renderLayers() {
            const { buildings = DATA_URL.BUILDINGS, trips = DATA_URL.TRIPS, trailLength = 180 } = this.props;

            return [
                new TripsLayer({
                    id: 'trips',
                    data: trips,
                    getPath: d => d.segments,
                    getColor: d => (d.vendor === 0 ? [253, 128, 93] : [23, 184, 190]),
                    opacity: 0.3,
                    strokeWidth: 2,
                    trailLength,
                    currentTime: this.state.time
                }),
                new PolygonLayer({
                    id: 'buildings',
                    data: buildings,
                    extruded: true,
                    wireframe: false,
                    fp64: true,
                    opacity: 0.5,
                    getPolygon: f => f.polygon,
                    getElevation: f => f.height,
                    getFillColor: [74, 80, 87],
                    lightSettings: LIGHT_SETTINGS
                })
            ];
        }

        render() {
            const { viewState, controller = true, baseMap = true } = this.props;

            return (
                <DeckGL
                    layers={this._renderLayers()}
                    initialViewState={INITIAL_VIEW_STATE}
                    viewState={viewState}
                    controller={controller}
                >
                    {baseMap && (
                        <StaticMap
                            reuseMaps
                            mapStyle="mapbox://styles/mapbox/dark-v9"
                            preventStyleDiffing={true}
                            mapboxApiAccessToken={MAPBOX_TOKEN}
                        />
                    )}
                </DeckGL>
            );
        }
    }

    function renderToDOM(container) {
        render(<App />, container);
    }
</script>

</html>